name: Build Kernel - Snapdragon 7 Gen 3

on:
  workflow_dispatch: # Allows you to manually trigger the build from the Actions tab
    inputs:
      kernel_source:
        description: 'URL of the Kernel Source (Git)'
        required: true
        default: 'https://github.com/amit8705/kernel_xiaomi_mt6785ER' # Example placeholder
      kernel_branch:
        description: 'Branch to build'
        required: true
        default: 'main'
      defconfig_name:
        description: begonia_user_defconfig
        required: true
        default: begonia_user_defconfig

jobs:
  build-kernel:
    runs-on: ubuntu-22.04 # Use latest Ubuntu runner
    
    steps:
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32readline-dev lib32z1-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip libncurses-dev lib32ncurses6 lib32ncurses-dev

    - name: Clone Kernel Source
      run: |
        git clone --depth=1 -b ${{ inputs.kernel_branch }} ${{ inputs.kernel_source }} android_kernel
        echo "KERNEL_ROOT=$(pwd)/android_kernel" >> $GITHUB_ENV

    - name: Setup Clang Toolchain (AOSP Clang)
      run: |
        mkdir -p clang
        cd clang
        # Downloading a stable AOSP Clang version (Example: r450784d) suitable for Android 14/15
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
        tar -xzf clang-r487747c.tar.gz
        echo "CLANG_PATH=$(pwd)" >> $GITHUB_ENV

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        # Set Architecture and Paths
        export PATH=${{ env.CLANG_PATH }}/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        
        # Clean build directory
        make O=out clean
        make O=out mrproper

        # Configure
        make O=out ${{ inputs.defconfig_name }}

        # Build
        # LLVM=1 enables the full LLVM toolchain (Clang, LLD, etc.)
        make -j$(nproc --all) O=out \
             LLVM=1 \
             LLVM_IAS=1 \
             CROSS_COMPILE=aarch64-linux-gnu- \
             CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
             Image dtbo.img dtb

    - name: Package Kernel
      working-directory: ${{ env.KERNEL_ROOT }}/out/arch/arm64/boot
      run: |
        # Check if build was successful
        if [ -f "Image" ]; then
          echo "Build Success!"
        else
          echo "Build Failed! Image not found."
          exit 1
        fi
        
        # Package for upload
        mkdir -p release
        cp Image release/
        cp dts/vendor/qcom/*.dtb release/ || true # Copy DTBs if they exist here
        cp dts/vendor/qcom/*.dtbo release/ || true
        
        # Zip it up
        cd release
        zip -r kernel-build.zip .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: custom-kernel-sm7550
        path: ${{ env.KERNEL_ROOT }}/out/arch/arm64/boot/release/kernel-build.zip
